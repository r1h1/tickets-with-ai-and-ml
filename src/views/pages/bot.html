<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bot de Soporte Técnico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          crossorigin="anonymous">
    <link rel="stylesheet" href="../../assets/css/common.css">
    <style>
        .message-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            color: #37474F;
        }
    </style>
</head>
<body>

<nav class="navbar px-3 d-flex justify-content-between">
    <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
    </button>
    <a href="../../../index.html" class="btn btn-secondary">Cerrar Sesión</a>
</nav>

<div class="d-flex">
    <div class="sidebar" id="sidebar">
        <div class="px-3 mt-5">
            <a href="start.html">Dashboard</a>
            <a href="bot.html" class="active">Base de Conocimiento (Bot)</a>
            <a href="tickets.html">Tickets</a>
            <a href="categorias.html">Categorías</a>
            <a href="usuarios.html">Usuarios</a>
            <a href="roles.html">Roles</a>
        </div>
    </div>

    <div class="container-fluid p-5">
        <div class="mb-4 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Base de Conocimiento (Bot de IA)</h5>
            <button class="btn btn-secondary" onclick="resetTicket()">Nuevo Ticket</button>
        </div>

        <p class="text-secondary mt-4 mb-5">
            Este bot está diseñado exclusivamente para resolver problemas técnicos relacionados con sistemas operativos,
            redes o dispositivos móviles. Cada consulta
            que hagas al bot este aprenderá y dará mejores respuestas. Formula tus preguntas lo más claro posible para
            obtener una buena respuesta.
            Solo puedes hacer <strong>3 consultas</strong>. Si no obtienes solución, presiona el botón <strong>"Nuevo
            Ticket"</strong> para recibir atención personalizada de un agente humano.
        </p>

        <div class="input-box">
            <form id="formBot">
                <div class="mb-3">
                    <textarea class="form-control" id="mensaje" rows="3"
                              placeholder="Describe tu problema técnico y presiona enviar..." required></textarea>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-secondary">Enviar</button>
                </div>
            </form>
        </div>

        <div id="responseArea" class="mt-3"></div>
    </div>
</div>

<script>
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
    }

    function resetTicket() {
        document.getElementById('mensaje').value = '';
        document.getElementById('responseArea').innerHTML = '';
        sessionStorage.setItem('contadorMensajes', '0');
    }

    document.addEventListener('DOMContentLoaded', () => {
        sessionStorage.setItem('contadorMensajes', sessionStorage.getItem('contadorMensajes') || '0');

        document.getElementById('formBot').addEventListener('submit', async function (event) {
            event.preventDefault();

            const contador = parseInt(sessionStorage.getItem('contadorMensajes'));
            if (contador >= 3) {
                mostrarAviso('warning', 'Has llegado al límite de consultas por hoy. Por favor crea un nuevo ticket para recibir ayuda de un agente humano.');
                return;
            }

            const mensaje = document.getElementById('mensaje').value.trim();
            const cantidadPalabras = mensaje.split(/\s+/).filter(Boolean).length;

            const palabrasClaveTecnicas = [
                'windows', 'linux', 'mac', 'pantalla', 'ip', 'red', 'conexión', 'driver', 'actualización',
                'formateo', 'wifi', 'error', 'teclado', 'monitor', 'impresora', 'puerto', 'router',
                'audio', 'sonido', 'altavoz', 'parlante', 'controlador', 'música', 'reproducción',
                'compu', 'computadora', 'teléfono', 'android', 'ios', 'iphone', 'soporte', 'técnico'
            ];

            const palabrasDetectadas = palabrasClaveTecnicas.filter(palabra => mensaje.toLowerCase().includes(palabra));
            const esTecnico = palabrasDetectadas.length > 0;

            if (!mensaje || cantidadPalabras < 15 || !esTecnico) {
                let advertencia = 'Por favor describe tu problema técnico con al menos 15 palabras. ';
                advertencia += 'Además, incluye al menos una palabra relacionada con soporte técnico como ';
                advertencia += palabrasClaveTecnicas.slice(0, 5).join(', ') + '...';

                if (!esTecnico) {
                    advertencia += '<br><br>No se detectó ninguna palabra técnica clave en tu mensaje.';
                }

                mostrarAviso('warning', advertencia);
                return;
            }

            mostrarMensajeUsuario(mensaje);

            if (palabrasDetectadas.length > 0) {
                const palabraCard = document.createElement('div');
                palabraCard.className = 'message-card bg-info text-white';
                palabraCard.innerHTML = `<strong>Palabras técnicas detectadas:</strong> ${palabrasDetectadas.join(', ')}`;
                document.getElementById('responseArea').prepend(palabraCard);
            }

            mostrarCargando();

            const headers = {
                "Authorization": "Bearer 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",
                "Content-Type": "application/json",
                "HTTP-Referer": "http://localhost"
            };

            const body = {
                model: "deepseek/deepseek-r1:free",
                messages: [
                    {
                        role: "system",
                        content: "Eres un agente virtual de soporte técnico. Solo puedes responder preguntas sobre problemas " +
                            "técnicos reales relacionados con sistemas operativos (Windows, Linux, macOS), redes, software o " +
                            "dispositivos móviles. No debes ayudar en tareas escolares, universitarias, académicas, exámenes, " +
                            "investigaciones o explicaciones teóricas, ni responder temas de cocina, sexualidad, salud, política, " +
                            "comedia, música, consejos personales o cualquier otro asunto no técnico. Si detectas palabras " +
                            "como \"tarea\", \"universidad\", \"clase\", \"examen\", \"profesor\", \"tema de estudio\", \"receta\", " +
                            "\"sexo\", \"canción\", \"presidente\", \"meme\", entre otras, rechaza la solicitud amablemente indicando " +
                            "que no puedes ayudar con ese tipo de contenido. Usa español neutro, claro, sin símbolos ni formato especial. " +
                            "Si no puedes resolver el problema, indica al usuario que presione el botón \"Nuevo Ticket\" " +
                            "para recibir ayuda de un agente humano."
                    },
                    {
                        role: "user",
                        content: mensaje
                    }
                ]
            };

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                document.getElementById('loadingCard')?.remove();

                if (data.choices && data.choices.length > 0) {
                    const respuesta = data.choices[0].message.content;
                    const botCard = document.createElement('div');
                    botCard.className = 'message-card bg-light border';
                    botCard.innerHTML = `<strong>Bot:</strong><br>${respuesta}`;
                    document.getElementById('responseArea').prepend(botCard);
                    sessionStorage.setItem('contadorMensajes', (contador + 1).toString());
                } else {
                    throw new Error("Respuesta vacía");
                }

            } catch (error) {
                document.getElementById('loadingCard')?.remove();
                mostrarAviso('danger', 'Error al contactar al bot. Intenta de nuevo más tarde.');
                console.error("Error:", error);
            }
        });

        function mostrarAviso(tipo, mensaje) {
            const aviso = document.createElement('div');
            aviso.className = `message-card bg-${tipo} ${tipo === 'danger' ? 'text-white' : 'text-dark'}`;
            aviso.innerHTML = `<strong>Bot:</strong><br>${mensaje}`;
            document.getElementById('responseArea').prepend(aviso);
        }

        function mostrarMensajeUsuario(mensaje) {
            const userCard = document.createElement('div');
            userCard.className = 'message-card';
            userCard.innerHTML = `<strong>Tu consulta:</strong><br>${mensaje}`;
            document.getElementById('responseArea').prepend(userCard);
            document.getElementById('mensaje').value = '';
        }

        function mostrarCargando() {
            const loadingCard = document.createElement('div');
            loadingCard.className = 'message-card bg-light border';
            loadingCard.id = 'loadingCard';
            loadingCard.innerHTML = `<strong>Bot:</strong><br>Espera un momento, el bot está trabajando en una respuesta...`;
            document.getElementById('responseArea').prepend(loadingCard);
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
</body>
</html>