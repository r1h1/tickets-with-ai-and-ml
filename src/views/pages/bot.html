<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          crossorigin="anonymous">
    <link rel="stylesheet" href="../../assets/css/common.css">
    <style>
        .message-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            color: #37474F;
        }
    </style>
</head>
<body>
<nav class="navbar px-3 d-flex justify-content-between">
    <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
    </button>
    <a href="../../../index.html" class="btn btn-secondary">Cerrar Sesión</a>
</nav>
<div class="d-flex">
    <div class="sidebar" id="sidebar">
        <div class="px-3 mt-5">
            <a href="start.html">Dashboard</a>
            <a href="bot.html" class="active">Base de Conocimiento (Bot)</a>
            <a href="tickets.html">Tickets</a>
            <a href="categorias.html">Categorias</a>
            <a href="usuarios.html">Usuarios</a>
            <a href="roles.html">Roles</a>
        </div>
    </div>
    <div class="container-fluid p-5">
        <div class="mb-4 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Base de Conocimiento (Bot Autónomo de IA)</h5>
            <button class="btn btn-secondary" onclick="resetTicket()">Nuevo Ticket</button>
        </div>
        <p class="text-secondary mt-5 mb-5">
            En este apartado puedes hacer tus consultas referente a alguna inquietud de soporte a nuestro bot de
            inteligencia artificial (tienes solamente
            3 consultas para realizar, luego deberás abrir un nuevo ticket para que te atienda un agente humano).
            Si no estás satisfecho o pudiste resolver el inconveniente, crea un ticket en "Nuevo Ticket" para que un
            agente de soporte humano pueda atenderte.
        </p>

        <div class="input-box">
            <form id="formBot">
                <div class="mb-3">
                    <textarea class="form-control" id="mensaje" rows="3"
                              placeholder="Describe tu solicitud y presiona enviar..." required></textarea>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-secondary">Enviar</button>
                </div>
            </form>
        </div>

        <div id="responseArea" class="mt-3"></div>
    </div>
</div>

<script>
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
    }

    function resetTicket() {
        document.getElementById('mensaje').value = '';
        document.getElementById('responseArea').innerHTML = '';
        sessionStorage.setItem('contadorMensajes', '0');
    }

    document.addEventListener('DOMContentLoaded', () => {
        sessionStorage.setItem('contadorMensajes', sessionStorage.getItem('contadorMensajes') || '0');

        document.getElementById('formBot').addEventListener('submit', async function (event) {
            event.preventDefault();

            const contador = parseInt(sessionStorage.getItem('contadorMensajes'));
            if (contador >= 3) {
                const aviso = document.createElement('div');
                aviso.className = 'message-card bg-warning text-dark';
                aviso.innerHTML = '<strong>Bot:</strong><br>Por favor crea un nuevo ticket para un agente humano.';
                document.getElementById('responseArea').prepend(aviso);
                return;
            }

            const mensaje = document.getElementById('mensaje').value.trim();
            const cantidadPalabras = mensaje.split(/\s+/).filter(Boolean).length;

            if (!mensaje || cantidadPalabras < 15) {
                const aviso = document.createElement('div');
                aviso.className = 'message-card bg-warning text-dark';
                aviso.innerHTML = '<strong>Bot:</strong><br>Por favor describe mejor tu solicitud con al menos 15 palabras, intenta de nuevo.';
                document.getElementById('responseArea').prepend(aviso);
                return;
            }

            // Mostrar mensaje del usuario
            const userCard = document.createElement('div');
            userCard.className = 'message-card';
            userCard.innerHTML = `<strong>Tu consulta:</strong><br>${mensaje}`;
            document.getElementById('responseArea').prepend(userCard);
            document.getElementById('mensaje').value = '';

            // Crear card de carga
            const loadingCard = document.createElement('div');
            loadingCard.className = 'message-card bg-light border';
            loadingCard.id = 'loadingCard';
            loadingCard.innerHTML = `<strong>Bot:</strong><br>Espera un momento, el bot está trabajando en una respuesta adecuada...`;
            document.getElementById('responseArea').prepend(loadingCard);

            const headers = {
                "Authorization": "Bearer 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",
                "Content-Type": "application/json",
                "HTTP-Referer": "http://localhost"
            };

            const body = {
                model: "deepseek/deepseek-r1:free",
                max_tokens: 500,
                messages: [
                    {
                        role: "system",
                        content: "Eres un agente de soporte técnico especializado en sistemas operativos (Windows, Linux, macOS), redes y dispositivos móviles. Responde únicamente consultas técnicas, en español neutro, de manera clara, sin formato especial ni modismos. Si el problema persiste, indica al usuario que presione el botón 'Nuevo Ticket' para ser atendido por un agente humano."
                    },
                    {
                        role: "user",
                        content: mensaje
                    }
                ]
            };

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                const loading = document.getElementById('loadingCard');
                if (loading) loading.remove();

                if (data.choices && data.choices.length > 0) {
                    const respuesta = data.choices[0].message.content;
                    const botCard = document.createElement('div');
                    botCard.className = 'message-card bg-light border';
                    botCard.innerHTML = `<strong>Bot:</strong><br>${respuesta}`;
                    document.getElementById('responseArea').prepend(botCard);
                    sessionStorage.setItem('contadorMensajes', (contador + 1).toString());
                } else {
                    throw new Error("Respuesta vacía");
                }

            } catch (error) {
                const loading = document.getElementById('loadingCard');
                if (loading) loading.remove();

                const errorCard = document.createElement('div');
                errorCard.className = 'message-card bg-danger text-white';
                errorCard.textContent = "Error al contactar al bot. Intenta de nuevo.";
                document.getElementById('responseArea').prepend(errorCard);
                console.error("Error:", error);
            }
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.min.js"
        crossorigin="anonymous"></script>
</body>
</html>